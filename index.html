<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Snaphunt</title>
    <link rel="stylesheet" href="assets/css/main.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <div id="loading-screen" class="screen active"><div class="spinner"></div></div>

    <div id="join-screen" class="screen hidden">
        <h1>Join Game</h1>
        <input type="text" id="join-code" placeholder="Join Code" maxlength="6" />
        <input type="text" id="player-name" placeholder="Your Name" maxlength="50" />
        <button id="join-btn">Join</button>
        <a href="admin.html">Create New Game</a>
    </div>

    <div id="team-screen" class="screen hidden">
        <h1 id="game-title">Game Name</h1>
        <h2>Choose Your Team</h2>

        <div id="existing-teams">
            <h3>Existing Teams</h3>
            <div id="teams-list"></div>
        </div>

        <div id="game-control-section" class="hidden">
            <div id="captain-controls" class="hidden">
                <h3>Game Captain Controls</h3>
                <button id="start-game-btn" class="btn-primary">üöÄ Start Game</button>
                <p class="help-text">Start the game when all teams are ready</p>
            </div>

            <div id="game-status">
                <div class="status-card">
                    <h4>Game Status: <span id="current-status">Waiting for players</span></h4>
                    <div id="teams-summary"></div>
                </div>
            </div>
        </div>

        <div id="create-team">
            <h3>Create New Team</h3>
            <input type="text" id="team-name" placeholder="Team Name" maxlength="50" />
            <select id="team-role">
                <option value="hunted">Hunted (Fleeing Team)</option>
                <option value="hunter">Hunter (Chasing Team)</option>
            </select>
            <button id="create-team-btn">Create Team</button>
        </div>

        <button id="back-to-join">Back to Join</button>
    </div>

    <div id="game-screen" class="screen hidden">
        <header id="game-header">
            <div id="game-info">
                <span id="game-name">Game Name</span>
                <span id="team-role" class="role-badge">HUNTER</span>
            </div>
            <div id="game-status">
                <span id="photo-timer">Next photo in: 2:00</span>
                <span id="game-timer">Game time: 00:00</span>
            </div>
        </header>

        <main id="game-main">
            <div id="map-container">
                <div id="map"></div>
                <div id="map-controls">
                    <button id="center-map">üìç Center</button>
                    <button id="toggle-fullscreen">üîç Fullscreen</button>
                </div>
            </div>

            <div id="game-controls">
                <div id="role-specific-controls">
                    <!-- Controls will be dynamically added based on role -->
                </div>

                <div id="photo-feed">
                    <h3>Recent Photos</h3>
                    <div id="photos-container"></div>
                </div>
            </div>
        </main>

        <button id="leave-game">Leave Game</button>
    </div>

    <!-- Global error handlers -->
    <script>
        window.addEventListener('error', function (e) {
            console.error('Global error:', e.message, 'at', e.filename + ':' + e.lineno + ':' + e.colno);
        });
        window.addEventListener('unhandledrejection', function (e) {
            console.error('Unhandled promise rejection:', e.reason);
        });
    </script>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            onload="console.log('‚úÖ Leaflet script loaded')"
            onerror="console.error('‚ùå Failed to load Leaflet script', event)"></script>
    <script>
console.log('üöÄ Working inline script!');

function getDeviceId() {
    let id = localStorage.getItem('deviceId');
    if (!id) {
        id = crypto.randomUUID();
        localStorage.setItem('deviceId', id);
    }
    return id;
}

function storeSession(gameData, teamData, playerData, code) {
    localStorage.setItem('currentGame', JSON.stringify({ code, name: gameData.name }));
    localStorage.setItem('currentTeam', JSON.stringify(teamData));
    localStorage.setItem('currentPlayer', JSON.stringify(playerData));
}

function showLoading() {
    const l = document.getElementById('loading-screen');
    if (l) l.classList.add('active');
}

function hideLoading() {
    const l = document.getElementById('loading-screen');
    if (l) l.classList.remove('active');
}

const gameState = {
    game: null,
    team: null,
    player: null,
    status: 'waiting',
    map: null,
    marker: null,
    watchId: null,
    timers: { game: null, photo: null }
};

function startGame(teamData, playerData, gameData) {
    const teamScreen = document.getElementById('team-screen');
    const gameScreen = document.getElementById('game-screen');

    teamScreen.classList.add('hidden');
    teamScreen.classList.remove('active');
    gameScreen.classList.remove('hidden');
    gameScreen.classList.add('active');

    gameState.game = gameData;
    gameState.team = teamData;
    gameState.player = playerData;
    gameState.status = 'active';

    // Update header
    document.getElementById('game-name').textContent = gameData.name;
    const roleBadge = document.getElementById('team-role');
    roleBadge.textContent = teamData.role.toUpperCase();
    roleBadge.classList.remove('hunter', 'hunted');
    roleBadge.classList.add(teamData.role);
    gameScreen.classList.remove('role-hunter', 'role-hunted');
    gameScreen.classList.add(`role-${teamData.role}`);

    // Initialize map
    if (gameState.map) {
        gameState.map.remove();
    }
    gameState.map = L.map('map').setView([48.2082, 16.3738], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap'
    }).addTo(gameState.map);

    // Map controls
    document.getElementById('center-map').onclick = () => {
        if (gameState.marker) {
            gameState.map.setView(gameState.marker.getLatLng());
        }
    };
    document.getElementById('toggle-fullscreen').onclick = () => {
        document.getElementById('map-container').classList.toggle('fullscreen');
        gameState.map.invalidateSize();
    };

    // Geolocation
    if (navigator.geolocation) {
        gameState.watchId = navigator.geolocation.watchPosition(pos => {
            const latlng = [pos.coords.latitude, pos.coords.longitude];
            if (!gameState.marker) {
                gameState.marker = L.marker(latlng).addTo(gameState.map);
            } else {
                gameState.marker.setLatLng(latlng);
            }
            gameState.map.setView(latlng);
            const locStatus = document.getElementById('loc-status');
            if (locStatus) locStatus.textContent = 'Location: sharing';
        }, err => {
            console.warn('Geolocation error', err);
            const locStatus = document.getElementById('loc-status');
            if (locStatus) locStatus.textContent = 'Location: unavailable';
        }, { enableHighAccuracy: true });
    } else {
        console.warn('Geolocation not supported');
    }

    // Role specific controls
    const controls = document.getElementById('role-specific-controls');
    controls.innerHTML = '';
    if (teamData.role === 'hunted') {
        controls.innerHTML = `
        <div id="hunted-controls">
            <div id="photo-slot-info">
                <h3>Photo Slot: <span id="current-slot-code">--</span></h3>
                <div id="slot-timer">Upload required in: <span id="slot-countdown">--:--</span></div>
            </div>
            <div id="photo-upload-section">
                <input type="file" id="photo-input" accept="image/*" capture="environment" style="display:none">
                <button id="take-photo-btn" class="primary-action">üì∏ Upload Photo</button>
                <div id="upload-preview"></div>
                <div id="upload-status"></div>
            </div>
            <div id="slot-code-display">
                <p>Include this code in your photo:</p>
                <div id="slot-code-visual">--</div>
            </div>
        </div>`;

        const joinInfo = JSON.parse(localStorage.getItem('currentGame'));
        const slotCodeEl = document.getElementById('current-slot-code');
        const slotVisual = document.getElementById('slot-code-visual');
        const countdownEl = document.getElementById('slot-countdown');
        let currentSlot = null;
        let slotTimer = null;

        async function refreshSlot() {
            try {
                const res = await fetch(`api/game.php?action=current_slot&code=${joinInfo.code}`);
                const data = await res.json();
                if (res.ok) {
                    currentSlot = data;
                    slotCodeEl.textContent = data.slot_code;
                    slotVisual.textContent = data.slot_code;
                    startCountdown(new Date(data.deadline).getTime());
                }
            } catch (e) { console.error(e); }
        }

        function startCountdown(endTime) {
            if (slotTimer) clearInterval(slotTimer);
            slotTimer = setInterval(() => {
                const rem = Math.max(0, Math.floor((endTime - Date.now())/1000));
                const m = Math.floor(rem / 60);
                const s = rem % 60;
                countdownEl.textContent = `${m}:${s.toString().padStart(2,'0')}`;
                if (rem <= 0) clearInterval(slotTimer);
            }, 1000);
        }

        const fileInput = document.getElementById('photo-input');
        const takePhotoBtn = document.getElementById('take-photo-btn');
        const preview = document.getElementById('upload-preview');
        const statusEl = document.getElementById('upload-status');

        takePhotoBtn.onclick = () => fileInput.click();
        fileInput.onchange = async () => {
            const file = fileInput.files[0];
            if (!file || !currentSlot) return;
            preview.innerHTML = '';
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            preview.appendChild(img);

            const fd = new FormData();
            fd.append('slot_id', currentSlot.slot_id);
            fd.append('team_id', teamData.id);
            fd.append('player_id', playerData.id);
            fd.append('slot_code_verification', currentSlot.slot_code);
            fd.append('photo', file);
            statusEl.textContent = 'Uploading...';
            try {
                const res = await fetch('api/photo.php?action=upload', { method: 'POST', body: fd });
                const data = await res.json();
                if (res.ok) {
                    statusEl.textContent = 'Uploaded!';
                    loadRecentPhotos();
                    refreshSlot();
                } else {
                    statusEl.textContent = data.error || 'Upload failed';
                }
            } catch (e) {
                statusEl.textContent = 'Network error';
            }
            fileInput.value = '';
        };

        async function loadRecentPhotos() {
            try {
                const res = await fetch(`api/photo.php?action=recent&game_id=${gameData.id}`);
                const data = await res.json();
                if (res.ok) {
                    const container = document.getElementById('photos-container');
                    container.innerHTML = '';
                    data.photos.forEach(p => {
                        const img = document.createElement('img');
                        img.src = p.file_path;
                        img.title = `${p.team_name} - ${p.slot_code}`;
                        container.prepend(img);
                    });
                }
            } catch (e) { console.error(e); }
        }

        refreshSlot();
        loadRecentPhotos();
    } else {
        controls.innerHTML = `
            <button id="request-location" class="primary-action">Request Location</button>
            <button id="attempt-capture">Capture</button>
            <div id="distance-info">Distance: --</div>`;
    }

    // Timers
    const gameTimerEl = document.getElementById('game-timer');
    const photoTimerEl = document.getElementById('photo-timer');
    let gameSeconds = 0;
    if (gameState.timers.game) clearInterval(gameState.timers.game);
    gameState.timers.game = setInterval(() => {
        gameSeconds++;
        const m = Math.floor(gameSeconds / 60);
        const s = gameSeconds % 60;
        gameTimerEl.textContent = `Game time: ${m}:${s.toString().padStart(2,'0')}`;
    }, 1000);

    let photoSeconds = 120;
    if (gameState.timers.photo) clearInterval(gameState.timers.photo);
    gameState.timers.photo = setInterval(() => {
        photoSeconds--;
        if (photoSeconds < 0) photoSeconds = 120;
        const m = Math.floor(photoSeconds / 60);
        const s = photoSeconds % 60;
        photoTimerEl.textContent = `Next photo in: ${m}:${s.toString().padStart(2,'0')}`;
    }, 1000);

    // Leave game
    document.getElementById('leave-game').onclick = () => {
        if (confirm('Leave game?')) {
            if (gameState.watchId) navigator.geolocation.clearWatch(gameState.watchId);
            Object.values(gameState.timers).forEach(t => t && clearInterval(t));
            if (gameState.map) {
                gameState.map.remove();
                gameState.map = null;
            }
            localStorage.removeItem('currentGame');
            localStorage.removeItem('currentTeam');
            localStorage.removeItem('currentPlayer');

            const joinScreen = document.getElementById('join-screen');
            gameScreen.classList.add('hidden');
            gameScreen.classList.remove('active');
            joinScreen.classList.remove('hidden');
            joinScreen.classList.add('active');
            gameState.status = 'finished';
        }
    };
  }

function setupLobby(teamData, playerData, gameData, code) {
    const controlSection = document.getElementById('game-control-section');
    const captainControls = document.getElementById('captain-controls');
    if (controlSection) controlSection.classList.remove('hidden');
    if (playerData.is_captain && captainControls) {
        captainControls.classList.remove('hidden');
    }

    const startBtn = document.getElementById('start-game-btn');
    if (startBtn) {
        startBtn.onclick = async () => {
            showLoading();
            try {
                await fetch(`api/game.php?action=start&code=${code}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device_id: getDeviceId() })
                });
            } catch (e) {
                alert('Network error');
            } finally {
                hideLoading();
            }
        };
    }

    async function refreshLobby() {
        try {
            const statusRes = await fetch(`api/game.php?action=status&code=${code}`);
            const statusData = await statusRes.json();
            if (statusRes.ok) {
                const statusEl = document.getElementById('current-status');
                if (statusEl) statusEl.textContent = statusData.status === 'active' ? 'Game started' : 'Waiting for players';
                if (statusData.status === 'active') {
                    clearInterval(lobbyTimer);
                    startGame(teamData, playerData, gameData);
                    return;
                }
            }
        } catch (e) {}

        try {
            const teamRes = await fetch(`api/team.php?action=list&game_code=${code}`);
            const teamDataRes = await teamRes.json();
            if (teamRes.ok) {
                const summary = document.getElementById('teams-summary');
                if (summary) {
                    summary.innerHTML = '';
                    teamDataRes.teams.forEach(t => {
                        const div = document.createElement('div');
                        div.className = `team-card role-${t.role}`;
                        const players = t.players.map(p => `${p.display_name}${p.is_captain ? ' üëë' : ''}`).join(', ');
                        div.innerHTML = `<strong>${t.name}</strong><div>${players}</div>`;
                        summary.appendChild(div);
                    });
                }
            }
        } catch (e) {}
    }

    refreshLobby();
    const lobbyTimer = setInterval(refreshLobby, 3000);

    const createSection = document.getElementById('create-team');
    if (createSection) createSection.classList.add('hidden');
    document.querySelectorAll('#existing-teams button').forEach(btn => btn.disabled = true);
}

function showTeamSelection(gameData, code, playerName) {
    const joinScreen = document.getElementById('join-screen');
    const teamScreen = document.getElementById('team-screen');
    const gameTitle = document.getElementById('game-title');
    const teamsList = document.getElementById('teams-list');
    const backBtn = document.getElementById('back-to-join');
    const createBtn = document.getElementById('create-team-btn');
    const teamName = document.getElementById('team-name');
    const teamRole = document.getElementById('team-role');

    joinScreen.classList.add('hidden');
    joinScreen.classList.remove('active');
    teamScreen.classList.remove('hidden');
    teamScreen.classList.add('active');

    gameTitle.textContent = gameData.name;
    const deviceId = getDeviceId();

      async function loadTeams() {
          teamsList.innerHTML = '';
          try {
              const res = await fetch(`api/team.php?action=list&game_code=${code}`);
              const data = await res.json();
              if (res.ok) {
                  if (data.teams.length === 0) {
                      teamsList.textContent = 'No teams yet.';
                  } else {
                      data.teams.forEach(team => {
                          const div = document.createElement('div');
                          div.className = `team-card role-${team.role}`;
                          const players = team.players.map(p => `${p.display_name}${p.is_captain ? ' üëë' : ''}`).join(', ');
                          div.innerHTML = `
                              <span class="team-name">${team.name}</span>
                              <span class="player-count">${team.player_count} players</span>
                              <div class="player-list">${players}</div>
                              <button data-code="${team.join_code}">Join</button>
                          `;
                          teamsList.appendChild(div);
                      });
                      teamsList.querySelectorAll('button').forEach(btn => {
                          btn.onclick = async () => {
                              const joinCode = btn.getAttribute('data-code');
                              showLoading();
                              try {
                                  const joinRes = await fetch('api/team.php?action=join', {
                                      method: 'POST',
                                      headers: { 'Content-Type': 'application/json' },
                                      body: JSON.stringify({
                                          team_join_code: joinCode,
                                          player_name: playerName,
                                        device_id: deviceId
                                      })
                                  });
                                  const joinData = await joinRes.json();
                                  if (joinRes.ok) {
                                      storeSession(gameData, joinData.team, joinData.player, code);
                                      setupLobby(joinData.team, joinData.player, gameData, code);
                                  } else {
                                      alert(`Error: ${joinData.error}`);
                                  }
                              } catch (e) {
                                  alert('Network error!');
                              } finally {
                                  hideLoading();
                              }
                          };
                      });
                  }
              } else {
                  teamsList.textContent = 'Failed to load teams';
              }
          } catch (e) {
              teamsList.textContent = 'Failed to load teams';
          }
      }

      createBtn.onclick = async () => {
          const tName = teamName.value.trim();
          const role = teamRole.value;
          if (!tName) return alert('Enter team name');
          showLoading();
          try {
              const res = await fetch('api/team.php?action=create', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                      game_code: code,
                      team_name: tName,
                      role,
                      player_name: playerName,
                      device_id: deviceId
                  })
              });
              const data = await res.json();
              if (res.ok) {
                  storeSession(gameData, data.team, data.player, code);
                  setupLobby(data.team, data.player, gameData, code);
              } else {
                  alert(`Error: ${data.error}`);
              }
          } catch (e) {
              alert('Network error!');
          } finally {
              hideLoading();
          }
      };

    backBtn.onclick = () => {
        teamScreen.classList.add('hidden');
        teamScreen.classList.remove('active');
        joinScreen.classList.remove('hidden');
        joinScreen.classList.add('active');
    };

    loadTeams();
}

setTimeout(() => {
    const loading = document.getElementById('loading-screen');
    const join = document.getElementById('join-screen');
    if (loading && join) {
        loading.classList.remove('active');
        join.classList.remove('hidden');
        join.classList.add('active');
        console.log('‚úÖ Screen switched!');

        const joinBtn = document.getElementById('join-btn');
        const joinCode = document.getElementById('join-code');
        const playerName = document.getElementById('player-name');

        if (joinBtn && joinCode && playerName) {
            joinCode.oninput = (e) => e.target.value = e.target.value.toUpperCase();
              joinBtn.onclick = async () => {
                  const code = joinCode.value.trim();
                  const name = playerName.value.trim();
                  if (!code || !name) return alert('Enter both code and name!');
                  showLoading();
                  try {
                      const res = await fetch(`api/game.php?action=get&code=${code}`);
                      const data = await res.json();
                      if (res.ok) {
                          showTeamSelection(data, code, name);
                      } else {
                          alert(`Error: ${data.error}`);
                      }
                  } catch(e) { alert('Network error!'); } finally { hideLoading(); }
              };
            console.log('‚úÖ Join setup complete!');
        }
    }
}, 1000);
</script>
</body>
</html>
